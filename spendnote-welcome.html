<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Welcome to SpendNote</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --primary: #10b981; --primary-dark: #059669;
            --border: #e2e8f0; --text: #0f172a; --text-muted: #64748b;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc; min-height: 100dvh; color: var(--text);
            display: flex; flex-direction: column;
        }

        /* ── Top nav ── */
        .top-nav {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 32px; border-bottom: 1px solid var(--border);
            background: #fff;
        }
        .nav-logo { display: flex; align-items: center; gap: 8px; font-size: 18px; font-weight: 900; color: var(--text); text-decoration: none; }
        .nav-logo svg { width: 26px; height: 26px; }
        .nav-skip { font-size: 13px; color: var(--text-muted); text-decoration: none; }
        .nav-skip:hover { color: var(--text); }

        /* ── Layout ── */
        .page-body {
            flex: 1; display: grid;
            grid-template-columns: 1fr 1fr;
            max-width: 1100px; width: 100%;
            margin: 0 auto; padding: 56px 32px;
            gap: 64px; align-items: start;
        }
        @media (max-width: 768px) {
            .page-body { grid-template-columns: 1fr; padding: 32px 20px; gap: 40px; }
            .right-panel { display: none; }
        }

        /* ── Left: form ── */
        .welcome-tag {
            display: inline-flex; align-items: center; gap: 6px;
            background: #ecfdf5; color: var(--primary-dark);
            font-size: 12px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.08em; padding: 5px 12px; border-radius: 20px;
            border: 1px solid #a7f3d0; margin-bottom: 20px;
        }
        .welcome-title {
            font-size: 32px; font-weight: 900; line-height: 1.15;
            letter-spacing: -0.5px; margin-bottom: 10px;
        }
        .welcome-title span { color: var(--primary-dark); }
        .welcome-sub {
            font-size: 15px; color: var(--text-muted); line-height: 1.6;
            margin-bottom: 36px; max-width: 400px;
        }

        /* ── Form card ── */
        .form-card {
            background: #fff; border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 24px rgba(15,23,42,0.07);
            overflow: hidden;
        }
        .form-card-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid #f1f5f9;
            background: linear-gradient(135deg, #f0fdf4, #f8fafc);
        }
        .form-card-header h3 {
            font-size: 15px; font-weight: 800; margin-bottom: 3px;
        }
        .form-card-header p { font-size: 13px; color: var(--text-muted); }
        .form-card-body { padding: 24px; }

        .form-group { margin-bottom: 20px; }
        .form-group:last-of-type { margin-bottom: 0; }
        .form-group label {
            display: block; font-size: 13px; font-weight: 700;
            margin-bottom: 7px; color: #374151;
        }
        .form-group label .opt { font-weight: 400; color: var(--text-muted); }
        .form-group input {
            width: 100%; border: 1.5px solid var(--border); border-radius: 10px;
            padding: 11px 14px; font-size: 14px; font-family: inherit;
            color: var(--text); background: #f8fafc; outline: none; transition: all 0.15s;
        }
        .form-group input:focus {
            border-color: var(--primary); background: #fff;
            box-shadow: 0 0 0 3px rgba(16,185,129,0.12);
        }
        .field-hint { font-size: 12px; color: var(--text-muted); margin-top: 5px; line-height: 1.4; }

        /* ── Avatar color ── */
        .color-row { display: flex; align-items: center; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .color-dot {
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
            border: 3px solid transparent; outline: 3px solid transparent;
            transition: transform 0.12s, outline-color 0.12s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.12);
        }
        .color-dot:hover { transform: scale(1.15); }
        .color-dot.active { outline-color: #0f172a; outline-offset: 2px; }

        /* ── Avatar preview inline ── */
        .avatar-inline {
            display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
            padding: 14px 16px; border-radius: 10px;
            background: #f0fdf4; border: 1px solid #a7f3d0;
        }
        .avatar-circle {
            width: 52px; height: 52px; border-radius: 50%; flex-shrink: 0;
            border: 3px solid var(--primary); background: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: 900; color: var(--primary);
            transition: border-color 0.2s, color 0.2s;
        }
        .avatar-inline-text { font-size: 13px; color: var(--text-muted); line-height: 1.4; }
        .avatar-inline-text strong { display: block; font-size: 14px; color: var(--text); margin-bottom: 2px; }

        /* ── Submit ── */
        .form-footer {
            padding: 20px 24px; border-top: 1px solid #f1f5f9;
            display: flex; align-items: center; justify-content: space-between; gap: 12px;
        }
        .btn-primary {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 13px 28px; border-radius: 10px; border: none; cursor: pointer;
            font-size: 15px; font-weight: 800; font-family: inherit;
            background: linear-gradient(135deg, #059669, #10b981);
            color: #fff; box-shadow: 0 4px 14px rgba(16,185,129,0.35);
            transition: all 0.15s;
        }
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #047857, #059669);
            box-shadow: 0 6px 20px rgba(16,185,129,0.45); transform: translateY(-1px);
        }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-skip { font-size: 13px; color: var(--text-muted); background: none; border: none; cursor: pointer; font-family: inherit; padding: 0; }
        .btn-skip:hover { color: var(--text); }
        .saving-spinner { display: none; }
        .saving-spinner.show { display: inline-block; }

        .error-msg {
            margin: 0 24px 16px; font-size: 13px; color: #dc2626;
            background: #fef2f2; border: 1px solid #fecaca;
            border-radius: 8px; padding: 10px 14px; display: none;
        }
        .error-msg.show { display: block; }

        /* ── Right: visual panel ── */
        .right-panel { padding-top: 8px; }
        .receipt-preview-label {
            font-size: 11px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 12px;
            display: flex; align-items: center; gap: 6px;
        }
        .receipt-mock {
            background: #fff; border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(15,23,42,0.10);
            padding: 24px; font-size: 12px; color: #374151;
            max-width: 340px;
        }
        .receipt-mock-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 16px; padding-bottom: 14px;
            border-bottom: 2px solid #000;
        }
        .receipt-mock-title { font-size: 16px; font-weight: 900; margin-bottom: 2px; }
        .receipt-mock-ids { font-size: 10px; color: #666; line-height: 1.6; text-align: right; }
        .receipt-mock-logo {
            width: 48px; height: 28px; border-radius: 4px;
            background: #f0fdf4; border: 1px dashed #a7f3d0;
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; color: #a7f3d0; font-weight: 700;
        }
        .receipt-mock-company { font-weight: 800; font-size: 13px; margin-bottom: 2px; }
        .receipt-mock-addr { font-size: 11px; color: #666; line-height: 1.5; }
        .receipt-mock-divider { height: 1px; background: #e5e7eb; margin: 14px 0; }
        .receipt-mock-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 11px; }
        .receipt-mock-row.total { font-weight: 800; font-size: 13px; padding-top: 8px; border-top: 1px solid #000; }
        .receipt-mock-disclaimer {
            font-size: 9px; color: #9ca3af; text-align: center;
            margin-top: 14px; padding-top: 10px; border-top: 1px solid #f1f5f9;
            line-height: 1.5;
        }
        .receipt-mock-highlight {
            background: #ecfdf5; border-radius: 6px; padding: 8px 10px;
            margin-bottom: 14px;
        }
        .mock-label { font-size: 9px; text-transform: uppercase; font-weight: 700; color: #6b7280; letter-spacing: 0.05em; }
        .mock-value { font-weight: 700; color: var(--text); font-size: 12px; }
        .mock-value.placeholder { color: #d1d5db; font-style: italic; font-weight: 400; }

        .tip-list { margin-top: 28px; }
        .tip-item {
            display: flex; gap: 12px; align-items: flex-start;
            margin-bottom: 14px;
        }
        .tip-icon {
            width: 32px; height: 32px; border-radius: 8px; flex-shrink: 0;
            background: #f0fdf4; border: 1px solid #a7f3d0;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; color: var(--primary-dark);
        }
        .tip-text { font-size: 13px; color: var(--text-muted); line-height: 1.5; padding-top: 6px; }
        .tip-text strong { color: var(--text); }
    </style>
</head>
<body>

<!-- Nav -->
<nav class="top-nav">
    <a href="dashboard.html" class="nav-logo">
        <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 6 C10 4.89543 10.8954 4 12 4 L36 4 C37.1046 4 38 4.89543 38 6 L38 38 L36 40 L34 38 L32 40 L30 38 L28 40 L26 38 L24 40 L22 38 L20 40 L18 38 L16 40 L14 38 L12 40 L10 38 Z" fill="url(#ng)"/>
            <path d="M32 4 L32 10 L38 10" stroke="#047857" stroke-width="1.5" stroke-linejoin="round"/>
            <line x1="14" y1="14" x2="30" y2="14" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
            <line x1="14" y1="20" x2="34" y2="20" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
            <line x1="14" y1="26" x2="28" y2="26" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
            <path d="M10 36 L12 38 L14 36 L16 38 L18 36 L20 38 L22 36 L24 38 L26 36 L28 38 L30 36 L32 38 L34 36 L36 38 L38 36" stroke="#047857" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            <defs><linearGradient id="ng" x1="24" y1="4" x2="24" y2="40" gradientUnits="userSpaceOnUse"><stop offset="0%" stop-color="#059669"/><stop offset="100%" stop-color="#10b981"/></linearGradient></defs>
        </svg>
        SpendNote
    </a>
    <a href="dashboard.html" class="nav-skip">Skip setup <i class="fas fa-arrow-right"></i></a>
</nav>

<!-- Body -->
<div class="page-body">

    <!-- LEFT: Form -->
    <div class="left-panel">
        <div class="welcome-tag"><i class="fas fa-hand-wave"></i> Welcome aboard</div>
        <h1 class="welcome-title">Let's get you<br>set up in <span>60 seconds</span></h1>
        <p class="welcome-sub">Just two things — your name and how you want to appear on receipts. Everything else is already ready to go.</p>

        <div class="form-card">
            <div class="form-card-header">
                <h3><i class="fas fa-user-circle" style="color:var(--primary);margin-right:6px;"></i> Your details</h3>
                <p>This info appears in the app and on your cash receipts.</p>
            </div>
            <div class="form-card-body">

                <div class="avatar-inline">
                    <div class="avatar-circle" id="avatarCircle"><span id="avatarInitials">?</span></div>
                    <div class="avatar-inline-text">
                        <strong id="avatarName">Your name</strong>
                        Pick a color for your avatar
                    </div>
                </div>

                <div class="form-group">
                    <label for="profileName">Your Full Name</label>
                    <input type="text" id="profileName" placeholder="e.g. Jane Smith" autocomplete="name">
                </div>

                <div class="form-group">
                    <label>Avatar Color</label>
                    <div class="color-row" id="colorRow">
                        <div class="color-dot active" data-color="#10b981" style="background:#10b981;"></div>
                        <div class="color-dot" data-color="#3b82f6" style="background:#3b82f6;"></div>
                        <div class="color-dot" data-color="#8b5cf6" style="background:#8b5cf6;"></div>
                        <div class="color-dot" data-color="#ec4899" style="background:#ec4899;"></div>
                        <div class="color-dot" data-color="#f59e0b" style="background:#f59e0b;"></div>
                        <div class="color-dot" data-color="#ef4444" style="background:#ef4444;"></div>
                        <div class="color-dot" data-color="#06b6d4" style="background:#06b6d4;"></div>
                        <div class="color-dot" data-color="#64748b" style="background:#64748b;"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="receiptName">Receipt Display Name</label>
                    <input type="text" id="receiptName" placeholder="e.g. Acme Corp or Jane Smith">
                    <div class="field-hint">This is the name that appears on every receipt you generate.</div>
                </div>

                <div class="form-group">
                    <label for="receiptAddress">Address <span class="opt">(optional)</span></label>
                    <input type="text" id="receiptAddress" placeholder="e.g. 123 Main St, New York">
                    <div class="field-hint">Shown on receipts under your display name.</div>
                </div>

            </div>
            <div class="error-msg" id="errMsg"></div>
            <div class="form-footer">
                <button class="btn-skip" onclick="window.location.href='dashboard.html'">Skip for now</button>
                <button class="btn-primary" id="saveBtn" onclick="saveSetup()">
                    <span class="saving-spinner" id="spin"><i class="fas fa-circle-notch fa-spin"></i></span>
                    Go to Dashboard <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- RIGHT: Visual -->
    <div class="right-panel">
        <div class="receipt-preview-label"><i class="fas fa-receipt"></i> Receipt preview</div>
        <div class="receipt-mock">
            <div class="receipt-mock-header">
                <div>
                    <div class="receipt-mock-title">Cash Receipt</div>
                    <div style="font-size:10px;color:#666;">Proof of cash handoff</div>
                </div>
                <div style="text-align:right;">
                    <div class="receipt-mock-ids">Cash Box ID: SN-001<br>Receipt ID: SN1-001<br>02/25/2026</div>
                </div>
            </div>

            <div class="receipt-mock-highlight">
                <div class="mock-label">From (your organization)</div>
                <div class="mock-value" id="mockCompany" style="color:#d1d5db;font-style:italic;font-weight:400;">Your display name</div>
                <div style="font-size:11px;color:#9ca3af;margin-top:2px;" id="mockAddress"></div>
            </div>

            <div class="receipt-mock-highlight">
                <div class="mock-label">To (contact)</div>
                <div class="mock-value">John Doe</div>
                <div style="font-size:11px;color:#6b7280;margin-top:2px;">456 Oak Ave, Chicago</div>
            </div>

            <div class="receipt-mock-row">
                <span>Office supplies</span><span>$45.00</span>
            </div>
            <div class="receipt-mock-row">
                <span>Taxi fare</span><span>$23.50</span>
            </div>
            <div class="receipt-mock-row total">
                <span>Total</span><span>$68.50</span>
            </div>

            <div class="receipt-mock-disclaimer">
                Proof of cash handoff. Not a tax document.<br>
                © SpendNote • spendnote.app
            </div>
        </div>

        <div class="tip-list">
            <div class="tip-item">
                <div class="tip-icon"><i class="fas fa-box"></i></div>
                <div class="tip-text"><strong>Cash Box ready.</strong> We've already set one up for you — start recording transactions right away.</div>
            </div>
            <div class="tip-item">
                <div class="tip-icon"><i class="fas fa-print"></i></div>
                <div class="tip-text"><strong>Instant receipts.</strong> Print, PDF or email receipts for every transaction, no extra setup needed.</div>
            </div>
            <div class="tip-item">
                <div class="tip-icon"><i class="fas fa-cog"></i></div>
                <div class="tip-text"><strong>More settings later.</strong> Logo, colors and team members can all be configured in Settings.</div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/js/supabase-config.js?v=20260225-2000"></script>
<script>
let selectedColor = '#10b981';

function getInitials(name) {
    const parts = String(name || '').trim().split(/\s+/).filter(Boolean);
    if (!parts.length) return '?';
    return (parts[0][0] + (parts[1] ? parts[1][0] : '')).toUpperCase();
}

function updatePreview() {
    const name = document.getElementById('profileName').value;
    const rName = document.getElementById('receiptName').value;
    const addr = document.getElementById('receiptAddress').value;

    document.getElementById('avatarInitials').textContent = getInitials(name);
    document.getElementById('avatarName').textContent = name.trim() || 'Your name';
    document.getElementById('avatarCircle').style.borderColor = selectedColor;
    document.getElementById('avatarCircle').style.color = selectedColor;

    const mockCompany = document.getElementById('mockCompany');
    if (rName.trim()) {
        mockCompany.textContent = rName.trim();
        mockCompany.style.cssText = 'font-weight:700;color:#0f172a;font-style:normal;';
    } else {
        mockCompany.textContent = 'Your display name';
        mockCompany.style.cssText = 'color:#d1d5db;font-style:italic;font-weight:400;';
    }
    document.getElementById('mockAddress').textContent = addr.trim();
}

document.getElementById('profileName').addEventListener('input', updatePreview);
document.getElementById('receiptName').addEventListener('input', updatePreview);
document.getElementById('receiptAddress').addEventListener('input', updatePreview);

document.getElementById('colorRow').querySelectorAll('.color-dot').forEach(dot => {
    dot.addEventListener('click', () => {
        document.getElementById('colorRow').querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
        dot.classList.add('active');
        selectedColor = dot.dataset.color;
        updatePreview();
    });
});

function showError(msg) {
    const el = document.getElementById('errMsg');
    el.textContent = msg;
    el.classList.toggle('show', Boolean(msg));
}

function setBusy(busy) {
    document.getElementById('saveBtn').disabled = busy;
    document.getElementById('spin').classList.toggle('show', busy);
}

function waitForDb() {
    return new Promise(resolve => {
        const check = () => window.db ? resolve() : setTimeout(check, 50);
        check();
    });
}

async function saveSetup() {
    showError('');
    const name    = document.getElementById('profileName').value.trim();
    const rName   = document.getElementById('receiptName').value.trim();
    const address = document.getElementById('receiptAddress').value.trim();

    if (!name) { showError('Please enter your full name.'); return; }
    if (!rName) { showError('Please enter a receipt display name.'); return; }

    setBusy(true);
    try {
        await waitForDb();
        const result = await window.db.profiles.update({
            full_name: name,
            avatar_color: selectedColor,
            company_name: rName,
            address: address || null
        });
        if (!result?.success) throw new Error(result?.error || 'Failed to save.');
        try { await window.supabaseClient.auth.updateUser({ data: { full_name: name, avatar_color: selectedColor } }); } catch (_) {}
        window.location.href = 'dashboard.html';
    } catch (e) {
        showError(String(e?.message || 'Something went wrong. Please try again.'));
        setBusy(false);
    }
}

// Pre-fill from auth on load
(async () => {
    try {
        await waitForDb();
        const user = await window.auth?.getCurrentUser?.();
        if (!user) { window.location.href = 'spendnote-login.html'; return; }
        const name = String(user.user_metadata?.full_name || '').trim();
        if (name) {
            document.getElementById('profileName').value = name;
            document.getElementById('receiptName').value = name;
            updatePreview();
        }
        try {
            const profile = await window.db.profiles.getCurrent();
            if (profile?.full_name) document.getElementById('profileName').value = profile.full_name;
            if (profile?.company_name) document.getElementById('receiptName').value = profile.company_name;
            if (profile?.address) document.getElementById('receiptAddress').value = profile.address;
            if (profile?.avatar_color) {
                selectedColor = profile.avatar_color;
                const match = document.querySelector(`#colorRow .color-dot[data-color="${profile.avatar_color}"]`);
                if (match) {
                    document.querySelectorAll('#colorRow .color-dot').forEach(d => d.classList.remove('active'));
                    match.classList.add('active');
                }
            }
            updatePreview();
        } catch (_) {}
    } catch (_) {}
})();
</script>
</body>
</html>
